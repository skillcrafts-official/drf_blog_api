name: Health Check DRF Blog API

on:
  workflow_dispatch:  # –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
    - cron: '*/30 * * * *'  # –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Check Production Health
      uses: appleboy/ssh-action@v0.1.5
      env:
        SERVER_URL: https://portfolio-blog-api.ru
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üè• STARTING HEALTH CHECK - $(date)"
          
          cd /opt/drf_blog_api
          
          # 1. CHECK DOCKER CONTAINERS
          echo "üê≥ Checking Docker containers..."
          CONTAINERS=$(sudo docker-compose -f docker-compose.prod.yml ps 2>/dev/null)
          
          if echo "$CONTAINERS" | grep -q "Up"; then
            echo "‚úÖ All containers are running"
            echo "$CONTAINERS"
          else
            echo "‚ùå Some containers are not running"
            echo "$CONTAINERS"
            exit 1
          fi
          
          # 2. CHECK DJANGO HEALTH
          echo "üêç Checking Django health..."
          
          # –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
          if curl -s -f http://localhost:8000/api/docs/ >/dev/null; then
            echo "‚úÖ Django responds locally"
          else
            echo "‚ùå Django does not respond locally"
            echo "üìã Container logs:"
            sudo docker-compose -f docker-compose.prod.yml logs web --tail=20 2>/dev/null || true
            exit 1
          fi
          
          # –í–Ω–µ—à–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞
          if curl -s -f -k https://portfolio-blog-api.ru/api/docs/ >/dev/null; then
            echo "‚úÖ Django responds externally"
          else
            echo "‚ö†Ô∏è Django does not respond externally (Nginx issue?)"
            echo "üìã Nginx logs:"
            sudo tail -20 /var/log/nginx/error.log 2>/dev/null || true
            # –ù–µ –≤—ã—Ö–æ–¥–∏–º —Å –æ—à–∏–±–∫–æ–π, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
          fi
          
          # 3. CHECK DATABASE
          echo "üóÑÔ∏è Checking database connection..."
          if sudo docker-compose -f docker-compose.prod.yml exec -T web python manage.py check --database default 2>/dev/null; then
            echo "‚úÖ Database connection OK"
          else
            echo "‚ùå Database connection failed"
            exit 1
          fi
          
          # 4. CHECK API ENDPOINTS
          echo "üîå Checking API endpoints..."
          
          ENDPOINTS=("/users/" "/api/docs/" "/api/schema/")
          for endpoint in "${ENDPOINTS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" -k https://portfolio-blog-api.ru$endpoint 2>/dev/null || echo "000")
            if [[ "$STATUS" =~ ^[23] ]]; then
              echo "‚úÖ $endpoint - HTTP $STATUS"
            else
              echo "‚ö†Ô∏è $endpoint - HTTP $STATUS"
            fi
          done
          
          # 5. DISK SPACE CHECK
          echo "üíæ Checking disk space..."
          df -h | grep "/dev/"
          
          # 6. FINAL REPORT
          echo ""
          echo "üìä ===== HEALTH CHECK SUMMARY ====="
          echo "‚úÖ All systems operational"
          echo "üìÖ Check completed at: $(date)"
          exit 0