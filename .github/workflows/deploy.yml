# Название workflow (отображается в GitHub UI)
name: Docker Build and Push

# Когда запускать workflow
on:
  # 1. При пуше в ветку main
  push:
    branches: 
      - main
  
env:
  # Константы
  REGISTRY: ghcr.io
  DOCKERFILE_PATH: ./Dockerfile
  PLATFORMS: linux/amd64,linux/arm64
  # Динамические переменные на основе контекста
  IMAGE_NAME: ${{ github.repository }}

# Jobs - основные задачи workflow
jobs:
  build:
    # Где запускать
    runs-on: ubuntu-latest  # или ubuntu-22.04, windows-latest, macos-latest
    # Разрешения (особенно для GitHub Packages)
    permissions:
      contents: read      # Чтение кода
      packages: write     # ОБЯЗАТЕЛЬНО: запись в GitHub Packages
      id-token: write     # Для OIDC аутентификации (рекомендуется)

    # Шаги выполнения
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container  # Использует контейнер для сборки

      - name: Extract Docker metadata
        id: meta  # Важно: даём ID для обращения к output
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=   # Используем хэш коммита как тег
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      # Вариант A: GitHub Container Registry (GHCR)
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}          # Имя пользователя GitHub
          password: ${{ secrets.GITHUB_TOKEN }}  # Автоматический токен
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .  # Директория с Dockerfile
          file: ./Dockerfile.prod  # Путь к Dockerfile
          platforms: linux/amd64,linux/arm64  # Multi-arch сборка
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
    
          # Кэширование для ускорения
          cache-from: type=gha  # Кэш из GitHub Actions
          cache-to: type=gha,mode=max
      
          # Build arguments (переменные сборки)
          build-args: |
            BUILD_DATE=${{ github.event.created_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ needs.build.result == 'success' }}
    # if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    
    steps:
      - name: Deploy to production
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.SERVER_HOST }}
          USER: ${{ secrets.SERVER_USER }}
          IMAGE_FULL: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key
          chmod 600 private_key
          
          ssh -o StrictHostKeyChecking=no -i private_key \
            ${USER}@${HOST} "
            # Команды для деплоя на сервере
            cd /opt/drf_blog_api/
            echo 'IMAGE_NAME=$IMAGE_FULL' > .env.docker
            git pull origin main
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            docker-compose -f docker-compose.prod.yml --env-file .env.docker down web
            docker-compose -f docker-compose.prod.yml --env-file .env.docker up -d web
            docker system prune -f
          "
