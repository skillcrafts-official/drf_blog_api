name: Deploy DRF Blog API

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Production
      uses: appleboy/ssh-action@v0.1.5
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script_stop: true
        script: |
          echo "ðŸš€ Starting deployment..."
          echo "Commit: ${{ github.sha }}"
          
          # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          cd /opt/drf_blog_api
          
          # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ git Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
          git config --global --add safe.directory /opt/drf_blog_api
          
          # Pull Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
          echo "ðŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼/Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .env Ñ„Ð°Ð¹Ð»
          echo "âš™ï¸  Updating environment variables..."
          cat > .env << 'EOF'
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=0
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          REDIS_URL=redis://redis:6379/0
          EOF
          
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° .env
          chmod 600 .env
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ Ð¿ÐµÑ€ÐµÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          echo "ðŸ³ Rebuilding Docker containers..."
          docker-compose -f docker-compose.prod.yml down
          docker-compose -f docker-compose.prod.yml build --no-cache --pull
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          echo "ðŸš€ Starting containers..."
          docker-compose -f docker-compose.prod.yml up -d
          
          # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° PostgreSQL
          echo "â³ Waiting for PostgreSQL..."
          sleep 10
          
          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
          echo "ðŸ“¦ Running migrations..."
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput
          
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          echo "ðŸ“ Collecting static files..."
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput
          
          # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Nginx (ÐµÑÐ»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ sudo Ð±ÐµÐ· Ð¿Ð°Ñ€Ð¾Ð»Ñ)
          echo "ðŸ”„ Restarting Nginx..."
          sudo systemctl restart nginx 2>/dev/null || echo "âš ï¸  Nginx restart skipped or failed"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
          echo "ðŸ¥ Health check..."
          sleep 5
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° 1: ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹
          if docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
            echo "âœ… Docker containers are running"
          else
            echo "âŒ Docker containers failed to start"
            docker-compose -f docker-compose.prod.yml ps
            exit 1
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° 2: Django Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚
          echo "ðŸ” Checking Django response..."
          if docker-compose -f docker-compose.prod.yml exec -T web python -c "
          import urllib.request
          try:
              # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ API docs
              req = urllib.request.Request('http://localhost:8000/api/docs/')
              req.add_header('User-Agent', 'GitHub-Actions-Health-Check')
              response = urllib.request.urlopen(req, timeout=10)
              print(f'âœ… Django API responding: HTTP {response.status}')
              exit(0)
          except Exception as e:
              print(f'âš ï¸  Django check: {getattr(e, \"code\", \"Error\")} - {getattr(e, \"reason\", str(e))}')
              # Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ 404, Ð½Ð¾ ÑÐµÑ€Ð²ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ - ÑÑ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾
              if hasattr(e, 'code') and e.code == 404:
                  print('â„¹ï¸  404 is OK - server is responding')
                  exit(0)
              exit(1)
          "; then
            echo "âœ… Django health check passed"
          else
            echo "âš ï¸  Django health check had issues, but continuing..."
          fi
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Docker Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
          echo "ðŸ§¹ Cleaning up old Docker images..."
          docker system prune -af --volumes 2>/dev/null || true
          
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸ“Š Application should be available at: http://$(hostname -I | awk '{print $1}')/api/docs/"
