name: Deploy DRF Blog API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Deploy to Production
      uses: appleboy/ssh-action@v0.1.5
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          echo "ğŸš€ Starting deployment..."
          
          cd /opt/drf_blog_api
          
          # 0. CLEANUP: ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ğ¼ Ğ¼ĞµÑÑ‚Ğ¾ Ğ½Ğ° Ğ´Ğ¸ÑĞºĞµ Ğ¿ĞµÑ€ĞµĞ´ ÑĞ±Ğ¾Ñ€ĞºĞ¾Ğ¹
          echo "ğŸ§¹ Cleaning up disk space..."
          
          # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Docker
          sudo docker system prune -a -f 2>/dev/null || true
          sudo docker volume prune -f 2>/dev/null || true
          
          # Ğ£Ğ´Ğ°Ğ»Ğ¸Ğ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹
          OLD_IMAGES=$(sudo docker images -q --filter "dangling=true" 2>/dev/null || echo "")
          if [ -n "$OLD_IMAGES" ]; then
            echo "ğŸ—‘ï¸ Removing old Docker images..."
            sudo docker rmi $OLD_IMAGES 2>/dev/null || true
          fi
          
          # ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ğ¼ ĞºÑÑˆ pip Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°Ñ…
          sudo docker exec drf_web pip cache purge 2>/dev/null || true
          
          # ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          sudo rm -rf /tmp/* 2>/dev/null || true
          sudo rm -rf /var/tmp/* 2>/dev/null || true
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ¼ Ğ¼ĞµÑÑ‚Ğ¾ Ğ½Ğ° Ğ´Ğ¸ÑĞºĞµ
          echo "ğŸ’¾ Disk space after cleanup:"
          df -h / 2>/dev/null || true
          
          # 1. Pull latest code
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          # 2. Create .env file
          echo "âš™ï¸ Creating .env file..."
          cat > .env << EOF
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }},portfolio-blog-api.ru,www.portfolio-blog-api.ru,localhost,127.0.0.1,37.77.105.19
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=postgres
          DB_PORT=5432
          CORS_ALLOWED_ORIGINS=https://react-blog-kappa-plum.vercel.app,https://portfolio-blog-api.ru
          CSRF_TRUSTED_ORIGINS=https://portfolio-blog-api.ru
          EOF
          chmod 600 .env
          
          # 3. Stop old containers
          echo "ğŸ³ Stopping old containers..."
          sudo docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
          
          # 4. Build with cache clearing
          echo "ğŸ”¨ Building Docker containers (with no cache)..."
          sudo docker-compose -f docker-compose.prod.yml build --no-cache --pull
          
          # 5. Start containers
          echo "ğŸš€ Starting containers..."
          sudo docker-compose -f docker-compose.prod.yml up -d
          
          # 6. Wait for services
          echo "â³ Waiting for services to start..."
          sleep 15
          
          # 7. Run Django commands with retry
          echo "ğŸ“¦ Running Django setup..."
          
          # ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ĞµĞ½Ğ¸ĞµĞ¼ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
          for i in {1..3}; do
            echo "Attempt $i: Running migrations..."
            if sudo docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput 2>/dev/null; then
              echo "âœ… Migrations successful"
              break
            else
              echo "âš ï¸ Migration attempt $i failed, waiting..."
              sleep 5
            fi
          done
          
          # Ğ¡Ğ±Ğ¾Ñ€ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ¸
          sudo docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput 2>/dev/null || \
            echo "âš ï¸ Static collection had issues"
          
          # 8. Restart Nginx
          echo "ğŸ”„ Restarting Nginx..."
          sudo systemctl restart nginx 2>/dev/null && echo "âœ… Nginx restarted" || echo "âš ï¸ Nginx restart skipped"
          
          # 9. Health check with retry
          echo "ğŸ¥ Running health check..."
          HEALTH_OK=false
          for i in {1..10}; do
            if curl -s -f http://localhost:8000/api/docs/ > /dev/null 2>&1; then
              echo "âœ… Django is healthy! (attempt $i)"
              HEALTH_OK=true
              break
            else
              echo "â³ Waiting for Django... (attempt $i)"
              sleep 5
            fi
          done
          
          if [ "$HEALTH_OK" = true ]; then
            echo "ğŸ‰ Deployment completed successfully!"
            exit 0
          else
            echo "âŒ Django health check failed after 10 attempts"
            echo "ğŸ“‹ Checking container logs..."
            sudo docker-compose -f docker-compose.prod.yml logs web --tail=50
            exit 1
          fi