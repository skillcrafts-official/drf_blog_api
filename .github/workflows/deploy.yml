name: Deploy DRF Blog API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Deploy to Production
      uses: appleboy/ssh-action@v0.1.5
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          echo "ğŸš€ Starting deployment..."
          
          cd /opt/drf_blog_api
          
          # 1. Pull latest code
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          # 2. Create .env file
          echo "âš™ï¸ Creating .env file..."
          cat > .env << EOF
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=postgres
          DB_PORT=5432
          CORS_ALLOWED_ORIGINS=https://react-blog-kappa-plum.vercel.app,https://portfolio-blog-api.ru
          CSRF_TRUSTED_ORIGINS=https://portfolio-blog-api.ru
          EOF
          chmod 600 .env
          
          # 3. Stop and rebuild Docker containers
          echo "ğŸ³ Rebuilding Docker containers..."
          docker-compose -f docker-compose.prod.yml down
          docker-compose -f docker-compose.prod.yml build --no-cache
          
          # 4. Start containers
          echo "ğŸš€ Starting containers..."
          docker-compose -f docker-compose.prod.yml up -d
          
          # 5. Wait for PostgreSQL to be ready
          echo "â³ Waiting for PostgreSQL..."
          sleep 10
          
          # 6. Run Django commands
          echo "ğŸ“¦ Running Django setup..."
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput
          
          # 7. Create superuser if doesn't exist (optional)
          echo "ğŸ‘‘ Checking superuser..."
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py shell -c "
          from django.contrib.auth import get_user_model
          User = get_user_model()
          if not User.objects.filter(username='admin').exists():
              User.objects.create_superuser('admin', 'admin@example.com', 'admin123')
              print('Superuser created')
          else:
              print('Superuser already exists')
          " || true
          
          # 8. Restart Nginx
          echo "ğŸ”„ Restarting Nginx..."
          sudo systemctl restart nginx
          
          # 9. Health check
          echo "ğŸ¥ Running health check..."
          sleep 5
          
          # Check if Django is responding
          if curl -s -f http://localhost:8000/api/docs/ > /dev/null; then
            echo "âœ… Django is healthy!"
          else
            echo "âŒ Django health check failed"
            exit 1
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"