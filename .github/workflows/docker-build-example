# Название workflow (отображается в GitHub UI)
name: Docker Build and Push

# Когда запускать workflow
on:
  # 1. При пуше в ветки
  push:
    branches: 
      - main      # Production сборка
      - develop   # Development сборка
      - 'feat/*'  # Любая ветка, начинающаяся с feat/
    
    # Можно фильтровать по путям файлов
    paths:
      - 'src/**'           # Если меняются файлы в src/
      - 'Dockerfile'       # Если меняется Dockerfile
      - 'requirements.txt' # Если меняются зависимости
      - '.github/workflows/**' # Если меняется сам workflow

  # 2. При создании тегов (версий)
  tags:
    - 'v*'                 # v1.0.0, v1.2.3, v2.0.0-beta.1
    - 'release-*'          # release-2024-01-01

  # 3. По расписанию (cron)
  schedule:
    - cron: '0 2 * * *'    # Каждый день в 02:00 UTC

  # 4. Вручную из UI GitHub
  workflow_dispatch:
    inputs:
      version:
        description: 'Версия для сборки'
        required: true
        default: 'latest'

# Переменные окружения (можно переиспользовать)
env:
  # Константы
  REGISTRY: ghcr.io
  DOCKERFILE_PATH: ./Dockerfile
  PLATFORMS: linux/amd64,linux/arm64
  
  # Динамические переменные на основе контекста
  IMAGE_NAME: ${{ github.repository }}  # vasya/myapp
  BRANCH_NAME: ${{ github.ref_name }}   # main, develop, feature-branch
  
  # Условные переменные
  IMAGE_TAG: |
    ${{ 
      github.event_name == 'pull_request' && 'pr-' + github.event.number ||
      github.ref_type == 'tag' && github.ref_name ||
      github.ref_name == 'main' && 'latest' ||
      github.ref_name 
    }}
  
  # Для тегов SemVer
  VERSION: ${{ github.ref_name }}

# Jobs - основные задачи workflow
jobs:
  build:
    # Где запускать
    runs-on: ubuntu-latest  # или ubuntu-22.04, windows-latest, macos-latest
    
    # Разрешения (особенно для GitHub Packages)
    permissions:
      contents: read      # Чтение кода
      packages: write     # Запись в GitHub Packages
      id-token: write     # Для OIDC аутентификации
    
    # Стратегия (например, для матрицы сборок)
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    # Запускать только при определенных условиях
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'
    
    # Переменные окружения для этого job
    env:
      BUILD_DATE: ${{ fromJSON('["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]')[github.event.created_at.month - 1] }}
    
    # Шаги выполнения
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
        # Опциональные параметры:
          fetch-depth: 0        # Полная история (нужно для тегов)
          ref: ${{ github.ref }} # Конкретная ветка/тег
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container  # Использует контейнер для сборки
          buildkitd-flags: --allow-insecure-entitlement security.insecure

      # Вариант A: GitHub Container Registry (GHCR)
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}          # Имя пользователя GitHub
          password: ${{ secrets.GITHUB_TOKEN }}  # Автоматический токен

      # Вариант B: Docker Hub
      # - name: Log in to Docker Hub
      #  uses: docker/login-action@v3
      #  with:
      #    username: ${{ secrets.DOCKERHUB_USERNAME }}
      #    password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Вариант C: AWS ECR
      # - name: Log in to Amazon ECR
      #  uses: aws-actions/amazon-ecr-login@v1

      - name: Extract Docker metadata
        id: meta  # ID для обращения к output
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
            # или несколько registry:
            ghcr.io/${{ github.repository }}
            docker.io/yourusername/yourimage
          tags: |
            # Стратегия тегирования:
            type=ref,event=branch               # main -> ghcr.io/...:main
            type=ref,event=pr                   # pr-123
            type=ref,event=tag                  # v1.0.0 -> :v1.0.0
            type=semver,pattern={{version}}     # v1.0.0 -> :1.0.0
            type=semver,pattern={{major}}.{{minor}} # v1.2.3 -> :1.2
            type=semver,pattern={{major}}       # v1.2.3 -> :1
            type=sha,prefix={{branch}}-         # main-a1b2c3d
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
          labels: |
            org.opencontainers.image.title=${{ github.event.repository.name }}
            org.opencontainers.image.description=${{ github.event.repository.description }}
            org.opencontainers.image.url=${{ github.event.repository.html_url }}
            org.opencontainers.image.source=${{ github.event.repository.clone_url }}
            org.opencontainers.image.version=${{ github.ref_name }}
            org.opencontainers.image.created=${{ fromJSON('"') }}{{ fromJSON('"') }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.licenses=${{ fromJSON(github.event.repository.license.spdx_id) }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .  # Директория с Dockerfile
          file: ./Dockerfile  # Путь к Dockerfile
          platforms: linux/amd64,linux/arm64  # Multi-arch сборка
          push: ${{ github.event_name != 'pull_request' }}  # Push только не для PR
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
    
          # Кэширование для ускорения
          cache-from: type=gha  # Кэш из GitHub Actions
          cache-to: type=gha,mode=max
      
          # Build arguments (переменные сборки)
          build-args: |
            BUILD_DATE=${{ github.event.created_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
    
          # Секреты при сборке (например, приватные токены)
          secrets: |
            GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
    
          # Дополнительные параметры
          provenance: mode=max  # SBOM и подписи (экспериментально)
          sbom: true

# Job 4: Деплой (опционально)
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    
    steps:
      - name: Deploy to production
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key
          chmod 600 private_key
          
          ssh -o StrictHostKeyChecking=no -i private_key \
            ${USER}@${HOST} "
            # Команды для деплоя на сервере
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            docker-compose -f docker-compose.prod.yml up -d
            docker system prune -f
          "
