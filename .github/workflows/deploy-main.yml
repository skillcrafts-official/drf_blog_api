name: Deploy DRF Blog API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Deploy to Production
      uses: appleboy/ssh-action@v0.1.5
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üöÄ STARTING DEPLOYMENT - $(date)"
          
          cd /opt/drf_blog_api
          
          # 1. AGGRESSIVE CLEANUP
          echo "üßπ STEP 1: Aggressive disk cleanup..."
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å—ë
          sudo docker-compose -f docker-compose.prod.yml down 2>/dev/null || echo "No containers to stop"
          
          # –£–¥–∞–ª—è–µ–º –í–°–Å –≤ Docker
          sudo docker system prune -a -f --volumes 2>/dev/null || echo "Docker cleanup failed"
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
          sudo docker images -q | xargs -r sudo docker rmi -f 2>/dev/null || echo "Image removal failed"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Å—Ç–æ
          echo "üíæ Disk space:"
          df -h | grep "/dev/"
          
          # 2. PULL CODE
          echo "üì• STEP 2: Pulling latest code..."
          git fetch origin 2>&1 | tail -5
          git reset --hard origin/main 2>&1 | tail -5
          
          # 3. CREATE ENV
          echo "‚öôÔ∏è STEP 3: Creating .env file..."
          cat > .env << 'EOF'
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }},portfolio-blog-api.ru,www.portfolio-blog-api.ru,localhost,127.0.0.1,37.77.105.19
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=postgres
          DB_PORT=5432
          CORS_ALLOWED_ORIGINS=https://react-blog-kappa-plum.vercel.app,https://portfolio-blog-api.ru
          CSRF_TRUSTED_ORIGINS=https://portfolio-blog-api.ru
          EOF
          chmod 600 .env
          
          # 4. BUILD & START
          echo "üê≥ STEP 4: Building and starting containers..."
          sudo docker-compose -f docker-compose.prod.yml build --no-cache 2>&1 | tail -20
          sudo docker-compose -f docker-compose.prod.yml up -d 2>&1 | tail -10
          
          # 5. WAIT AND RUN COMMANDS
          echo "‚è≥ STEP 5: Waiting for startup..."
          sleep 30
          
          echo "üì¶ STEP 6: Running Django commands..."
          
          # –ú–∏–≥—Ä–∞—Ü–∏–∏ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏)
          sudo docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput 2>&1 || \
            echo "‚ö†Ô∏è Migrations might have failed"
          
          # –°—Ç–∞—Ç–∏–∫–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏)
          sudo docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput 2>&1 || \
            echo "‚ö†Ô∏è Static collection might have failed"
          
          # 6. RESTART NGINX
          echo "üîÑ STEP 7: Restarting Nginx..."
          sudo systemctl restart nginx 2>&1 || echo "‚ö†Ô∏è Nginx restart failed"
          
          # 7. FINAL STATUS
          echo "üìä STEP 8: Deployment status..."
          echo "üìÖ Time: $(date)"
          echo "üîó Commit: $(git log --oneline -1)"
          echo "üê≥ Containers:"
          sudo docker-compose -f docker-compose.prod.yml ps 2>&1 || echo "‚ö†Ô∏è Cannot list containers"
          
          echo ""
          echo "üéâ DEPLOYMENT PROCESS COMPLETED"
          echo "‚ÑπÔ∏è  Run health-check workflow for verification"
          exit 0