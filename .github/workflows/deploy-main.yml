name: Deploy DRF Blog API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Deploy to Production
      uses: appleboy/ssh-action@v0.1.5
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üöÄ STARTING DEPLOYMENT - $(date)"
          
          cd /opt/drf_blog_api
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
          echo "üë§ User: $(whoami)"
          echo "üë• Groups: $(groups)"
          
          # 1. AGGRESSIVE CLEANUP (–ë–ï–ó SUDO!)
          echo "üßπ STEP 1: Aggressive disk cleanup..."
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å—ë
          docker-compose -f docker-compose.prod.yml down 2>/dev/null || echo "No containers to stop"
          
          # –£–¥–∞–ª—è–µ–º –í–°–Å –≤ Docker
          docker system prune -a -f --volumes 2>/dev/null || echo "Docker cleanup failed"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Å—Ç–æ
          echo "üíæ Disk space:"
          df -h | grep "/dev/"
          
          # 2. PULL CODE
          echo "üì• STEP 2: Pulling latest code..."
          git fetch origin 2>&1 | tail -5
          git reset --hard origin/main 2>&1 | tail -5
          
          # 3. CREATE ENV
          echo "‚öôÔ∏è STEP 3: Creating .env file..."
          cat > .env << 'EOF'
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }},portfolio-blog-api.ru,www.portfolio-blog-api.ru,localhost,127.0.0.1,37.77.105.19
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=postgres
          DB_PORT=5432
          CORS_ALLOWED_ORIGINS=https://react-blog-kappa-plum.vercel.app,https://portfolio-blog-api.ru
          CSRF_TRUSTED_ORIGINS=https://portfolio-blog-api.ru
          EOF
          chmod 600 .env
          
          # 4. BUILD & START (–ë–ï–ó SUDO!)
          echo "üê≥ STEP 4: Building and starting containers..."
          docker-compose -f docker-compose.prod.yml build --no-cache 2>&1 | tail -20
          docker-compose -f docker-compose.prod.yml up -d 2>&1 | tail -10
          
          # 5. WAIT AND RUN COMMANDS (–ë–ï–ó SUDO!)
          echo "‚è≥ STEP 5: Waiting for startup..."
          sleep 30
          
          echo "üì¶ STEP 6: Running Django commands..."
          
          # –ú–∏–≥—Ä–∞—Ü–∏–∏
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput 2>&1 || \
            echo "‚ö†Ô∏è Migrations might have failed"
          
          # –°—Ç–∞—Ç–∏–∫–∞
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput 2>&1 || \
            echo "‚ö†Ô∏è Static collection might have failed"
          
          # 6. RESTART NGINX (–≠–¢–û–¢ –ù–£–ñ–ï–ù SUDO!)
          echo "üîÑ STEP 7: Restarting Nginx..."
          # –ù–∞—Å—Ç—Ä–æ–π—Ç–µ NOPASSWD –¥–ª—è systemctl –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ sudo —Å –ø–∞—Ä–æ–ª–µ–º –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
          # –í–∞—Ä–∏–∞–Ω—Ç A: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å NOPASSWD –¥–ª—è systemctl
          # –í–∞—Ä–∏–∞–Ω—Ç B: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å service –≤–º–µ—Å—Ç–æ systemctl
          systemctl restart nginx 2>&1 || echo "‚ö†Ô∏è Nginx restart failed - may need sudo config"
          
          # –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ service (–∏–Ω–æ–≥–¥–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç sudo):
          # service nginx restart 2>&1 || echo "‚ö†Ô∏è Nginx restart failed"
          
          # 7. FINAL STATUS
          echo "üìä STEP 8: Deployment status..."
          echo "üìÖ Time: $(date)"
          echo "üîó Commit: $(git log --oneline -1)"
          echo "üê≥ Containers:"
          docker-compose -f docker-compose.prod.yml ps 2>&1 || echo "‚ö†Ô∏è Cannot list containers"
          
          echo ""
          echo "üéâ DEPLOYMENT PROCESS COMPLETED"
          echo "‚ÑπÔ∏è  Run health-check workflow for verification"
          exit 0